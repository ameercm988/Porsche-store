<section id="page-title" class="page-title">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12">
                {{!-- <h3>Checkout</h3> --}}
            </div>


        </div>

    </div>

</section>

<form id="checkout-form">
    <section style="margin-top: 30px;padding-top: 50px">
        <div class="container">
            <input name="userId" value="{{user._id}}" hidden>

            <div class="row">
                <div class="col-12" style="margin-bottom: 10px ;">

                    <div class="billing-address">

                        <h5 class="checkout-box-title">SAVED ADDRESS</h5>

                        <div class="row checkout-billing-adress-box">

                            {{#each savedAddress.address}}
                            <div class="col-md-3" style="border:solid #847f7f;">
                                <dl class="text-left">
                                    <dt>{{this.First_Name}} {{this.Last_Name}}</dt>
                                    <dd>"{{this.Company_Name}}"</dd>
                                    <dd>{{this.Street_Address}},{{this.Extra_Details}}</dd>
                                    <dd>{{this.Town_City}}, {{this.Country_State}}</dd>
                                    <dd>PIN:{{this.Post_Code}}</dd>
                                    <dd>Ph:{{this.Phone}}</dd>
                                    <dd>Alt-Ph:{{this.Alt_Phone}}</dd>
                                    <dt class="mt-1 mb-1 d-flex">
                                        <input type="radio" name="choice"
                                            onclick="savedAddressSelect('{{this.First_Name}}','{{this.Last_Name}}','{{this.Company_Name}}','{{this.Street_Address}}','{{this.Extra_Details}}','{{this.Town_City}}','{{this.Country_State}}','{{this.Post_Code}}','{{this.Phone}}','{{this.Alt_Phone}}')"
                                            id="useAddress"><span style="color: #007eff; margin-left: 3px;">Use
                                            Address</span>
                                    </dt><br>

                                </dl>
                            </div>
                            {{/each}}

                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8 col-sm-12 col-xs-12">
                    <div class="billing-address">
                        <h5 class="checkout-box-title">ADDRESS</h5>
                        <div class="checkout-billing-adress-box">

                            <div class="billing-address-input clearfix">
                                <label>FIRST NAME *</label>
                                <input type="text" name="First_Name" id="First_Name" required>
                            </div>
                            <div class="billing-address-input clearfix">
                                <label>LAST NAME *</label>
                                <input type="text" name="Last_Name" id="Last_Name" required>
                            </div>
                            <div class="billing-address-input clearfix">
                                <label>COMPANY / HOUSE NAME *</label>
                                <input type="text" name="Company_Name" id="Company_Name" required>
                            </div>
                            <div class="billing-address-input clearfix">
                                <label>ADDRESS *</label>
                                <input type="text" placeholder="Street Address" name="Street_Address"
                                    id="Street_Address" required>
                                <input type="text" placeholder="Fashin, suite, unite ect (optinal)" name="Extra_Details"
                                    id="Extra_Details" required>
                            </div>
                            <div class="billing-address-input clearfix">
                                <label>TOWN / CITY *</label>
                                <input type="text" name="Town_City" id="Town_City" required>
                            </div>
                            <div class="billing-address-input clearfix">
                                <label>COUNTRY / STATES</label>
                                <input type="text" name="Country_State" id="Country_State" required>
                            </div>
                            <div class="billing-address-input clearfix">
                                <label>POSTCODE / ZIP *</label>
                                <input type="text" name="Post_Code" id="Post_Code" required>
                            </div>
                            {{!-- <div class="billing-address-input clearfix">
                                <label>EMAIL ADDRESS *</label>
                                <input type="text">
                            </div> --}}
                            <div class="billing-address-input clearfix" style="margin-bottom:0px">
                                <label>PHONE *</label>
                                <input type="text" name="Phone" id="Phone" required>
                            </div>
                            <div class="cbab-create-account">
                                {{!-- <input onchange="useRegPnum1('{{ user.Pnum }}')" id="useRegPnum" type="checkbox">
                                --}}
                                <label>Use registered phone number</label>
                            </div>
                            <div class="billing-address-input clearfix">
                                <label>ALTERNATE PHONE *</label>
                                <input type="text" name="Alt_Phone" id="Alt_Phone">
                            </div><br>
                            <div class="cbab-create-account">
                                <input name="saveAddress" type="checkbox">
                                <label>Save address</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-sm-12 col-xs-12">
                    <div class="promotional-code-box">
                        <h5 class="checkout-box-title">COUPON CODE</h5>
                        <div class="pcb-content">
                            <p>Enter your coupon code if you have one</p>
                            <div class="pcb-cuppon-input clearfix">
                                
                                <input type="text" placeholder="Coupon code" name="Coupon_Code" id="couponInput" value="">
                                <div>
                                    <span id="couponValid"></span>
                                </div>
                                
                                <button onclick="couponCheck()"
                                    class="checkout-page-button hvr-bs">Apply</button>
                                    
                            </div>


        
                        </div>
                    </div>
                    <div class="your-order-box">
                        <h5 class="checkout-box-title">YOUR ORDER</h5>
                        <div class="yob-content">

                            {{!-- <ul>
                                <li class="clearfix">Cart Subtotal <span style="font-weight: bolder;font-size: 20px;">₹
                                        {{ctotal}}</span></li>
                                <li class="clearfix">Shipping and Handling <span>Free Shipping</span></li>
                                <li class="order-total clearfix">Order Total <span>₹ {{ctotal}}</span></li>
                            </ul> --}}

                            <ul>
                                <li class="clearfix">Cart Subtotal <span style="font-weight: bolder;font-size: 20px;">$
                                        {{totalAmount}}</span></li>
                                {{!-- <input name="totalfinalPrice" value="{{totalAmount}}" hidden> --}}
                                <li class="clearfix">Discount<span>- $<span id="totaldiscount">0</span></span></li>
                                <li class="clearfix">Shipping and Handling <span>Free Shipping</span></li>
                                <li class="order-total clearfix">Order Total <span>$ <span
                                            id="totalPrice">{{totalAmount}}</span></span></li>
                                <input type="hidden" name="totalfinalPrice" id="totalfinalPrice"
                                    value="{{totalAmount}}">
                                {{!-- <input type="hidden" name="usdToInr" id="usdToInr"> --}}
                            </ul>

                        </div>
                    </div>

                    <div class="promotional-code-box">
                        <h5 class="checkout-box-title">PAYMENT METHOD</h5>
                        <div class="pcb-content">
                            <p>Select your payment method</p>

                            <div class="pcb-cuppon-input clearfix">

                                <label
                                    style="margin-left: 10px;color: #000000;font-size: 14px;font-weight: 400;">COD</label>
                                <input type="radio" value="COD" name="Pay_Method" id="PaymethodCod" required>
                            </div>
                            <div class="pcb-cuppon-input clearfix">

                                <label
                                    style="margin-left: 10px;color: #000000;font-size: 14px;font-weight: 400;">Razorpay</label>
                                <input type="radio" value="Razorpay" name="Pay_Method" id="PaymethodRazpay" required>

                            </div>
                            {{!-- <div class="pcb-cuppon-input clearfix">

                                <label
                                    style="margin-left: 10px;color: #000000;font-size: 14px;font-weight: 400;">PayPal</label>
                                <input type="radio" value="PayPal" name="Pay_Method" id="PaymethodPayPal">

                            </div> --}}

                            {{!-- <div class="pcb-cuppon-input clearfix" id="paypal-button">

                            </div> --}}

                            <div class="create-account-checkout-method">
                                <div class="place-order" style="text-align: left;">
                                    <button class="checkout-page-button hvr-bs" onclick="" type="submit"
                                        id="submit-btn">Place
                                        order</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
    </section>
</form>




{{!-- coupon script  --}}

<script>
    function couponCheck()  {

        
        let code = $('#couponInput').val()
        console.log(code)
        $.ajax({
            url : '/check-coupon',
            data : {
                coupon : code,
            },
            method : 'post',

            success : (response) => {
                if(response.status){
                    $('#couponValid').show()
                    $('#couponValid').html('<i class="text-success fa-regular fa-circle-check"></i>  Valid Code')

                    setTimeout(() => {
                        $('#couponInput').prop('readonly', true)
                        console.log('hi');
                    }, 1000)

                    $('#totaldiscount').html(response.discount)

                    $('#totalPrice').html(response.amount)
                } else {

                    $('#couponValid').show()
                    $('#couponValid').html('<i class="fa-solid text-danger fa-xmark"></i> Invalid Code')
                    $("#discount").html(0)
                    setTimeout(() => {
                        $('#couponValid').hide()
                    }, 3000)

                }
            }
        })

    }
</script>

{{!-- save address script  --}}

<script>

    function savedAddressSelect(First_Name, Last_Name, Company_Name, Street_Address, Extra_Details, Town_City, Country_State, Post_Code, Phone, Alt_Phone) {
        document.getElementById('First_Name').value = First_Name
        document.getElementById('Last_Name').value = Last_Name
        document.getElementById('Company_Name').value = Company_Name
        document.getElementById('Street_Address').value = Street_Address
        document.getElementById('Extra_Details').value = Extra_Details
        document.getElementById('Town_City').value = Town_City
        document.getElementById('Country_State').value = Country_State
        document.getElementById('Post_Code').value = Post_Code
        document.getElementById('Phone').value = Phone
        document.getElementById('Alt_Phone').value = Alt_Phone
    }

</script>


<style>
    .error {
        color: red !important;
        font-size: x-small !important;
        margin-left: 10px
    }

    h6 {
        margin: 23px 0 0;
    }

    input {
        padding: none;
    }

    dl {
        margin: 0;
    }

    dd {
        margin: 0;
    }
</style>


<style>
    dt {
        color: black;
    }

    .checkout-top {
        margin-bottom: 23px;
    }

    .checkout-top p,
    .checkout-top p a {
        color: #000000;
        font-family: "Montserrat", sans-serif;
        font-size: 16px;
    }

    .checkout-top p a {
        color: #d22a28;
    }

    .checkout-box-title {
        border-bottom: 1px solid #ecedee;
        color: #000000;
        font-size: 18px;
        font-weight: normal;
        letter-spacing: 0;
        padding: 16px 0;
        text-align: center;
    }

    .billing-address {
        background: #fff none repeat scroll 0 0;
        border: 1px solid #ecedee;
    }

    .checkout-billing-adress-box {
        padding: 21px 35px 50px 25px;
    }

    .billing-address-input {
        margin-bottom: 20px;
    }

    .billing-address-input label {
        color: #000000;
        float: left;
        font-size: 14px;
        font-weight: 700;
        letter-spacing: 0;
    }

    .billing-address-input select,
    .billing-address-input input[type="text"] {
        border: 0 none;
        border-bottom: 1px solid #e5e5e5;
        color: #000000;
        float: right;
        font-size: 14px;
        font-weight: 300;
        height: 40px;
        padding: 0 10px;
        width: 55%;
    }

    .billing-address-input select option {}

    .cbab-create-account {
        margin-bottom: 19px;
    }

    .cbab-create-account input[type="checkbox"] {}

    .cbab-create-account label {
        color: #000000;
        font-size: 14px;
        font-weight: 300;
        letter-spacing: 0;
        line-height: 16px;
        margin: 0;
    }

    .cbab-create-account p {
        color: #000000;
        line-height: 24px;
        margin: 12px 0 0;
    }

    .cbab-account-password {
        margin: 0 0 31px;
    }

    .cbab-account-password label {
        color: #000000;
        font-size: 14px;
        font-weight: 300;
        letter-spacing: 0;
        line-height: 16px;
        margin: 0;
    }

    .cbab-account-password input[type="password"] {
        border: 0 none;
        border-bottom: 1px solid #e5e5e5;
        color: #000000;
        float: right;
        font-size: 14px;
        font-weight: 300;
        height: 40px;
        padding: 0 10px;
        width: 55%;
    }

    .cbab-order-notes {}

    .cbab-order-notes p {
        color: #000000;
        font-size: 14px;
        font-weight: 300;
        letter-spacing: 0;
        line-height: 16px;
        margin: 0 0 10px;
    }

    .cbab-order-notes input[type="text"] {
        border: 0 none;
        border-bottom: 1px solid #e5e5e5;
        color: #000000;
        font-size: 14px;
        font-weight: 300;
        height: 40px;
        padding: 0 10px;
        width: 100%;
    }

    .promotional-code-box {
        background: #fff none repeat scroll 0 0;
        border: 1px solid #ecedee;
        margin-bottom: 30px;
        margin-top: 30px;
    }

    .pcb-content {
        padding: 0 35px 25px;
    }

    .pcb-content p {
        color: #000000;
        margin-bottom: 25px;
    }

    .pcb-cuppon-input {}

    .pcb-cuppon-input input[type="text"] {
        border: 0 none;
        border-bottom: 1px solid #e5e5e5;
        color: #000000;
        float: left;
        font-weight: 300;
        height: 40px;
        letter-spacing: 0;
        text-align: center;
        width: 46%;
    }

    .pcb-cuppon-input button {
        float: right;
        width: 50%;
    }

    .checkout-page-button {
        background: #d22a28 none repeat scroll 0 0;
        border: 0 none;
        border-radius: 3px;
        color: #fff;
        display: inline-block;
        padding: 5px 30px;
        text-transform: uppercase;
    }

    .your-order-box {
        background: #fff none repeat scroll 0 0;
        border: 1px solid #ecedee;
        margin-bottom: 30px;
    }

    .yob-content {
        padding: 25px 25px 70px;
    }

    .yobc-title,
    .yobc-title span {
        color: #232530;
        font-family: "Montserrat", sans-serif;
        margin-bottom: 33px;
    }

    .yobc-title span {
        float: right;
    }

    .yob-content ul {
        list-style: outside none none;
        padding: 0;
    }

    .yob-content ul li {
        border-bottom: 1px solid #e5e5e5;
        color: #000000;
        font-size: 14px;
        font-weight: 400;
        letter-spacing: 0;
        line-height: 30px;
        margin: 0 0 27px;
        padding: 0 0 1px;
    }

    .yob-content ul li.order-total {
        text-transform: uppercase;
    }

    .yob-content ul li span {
        color: #d22a28;
        float: right;
    }

    .create-account-checkout-method {}

    .select-payment-method {
        margin-bottom: 3px;
    }

    .select-payment-method input[type="checkbox"] {}

    .select-payment-method label {
        color: #000000;
        font-size: 14px;
        font-weight: 300;
        letter-spacing: 0;
        margin-left: 10px;
    }

    .create-account-text {
        border: 1px solid #e5e5e5;
        margin: 0 0 20px;
        padding: 21px 20px;
    }

    .create-account-text p {
        color: #000000;
        font-weight: 300;
        line-height: 24px;
    }

    .place-order {
        margin: 15px 0 0;
        text-align: center;
    }

    .place-order button {}
</style>



{{!-- razorpay link --}}

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

{{!-- payment script --}}

<script>
    $("#checkout-form").submit((e) => {

        e.preventDefault()
        $.ajax({
            url: '/checkout',
            method: 'post',
            data: $('#checkout-form').serialize(),
            success: (response) => {

                swal("Confirming your order!", {
                    buttons: false,
                    timer: 2000,
                });
               
                    if (response.codSuccess) {
                    location.href = '/order-success'
                } else {
                    razorpayPayment(response)
                }
               
                
            }
        })
    })

    function razorpayPayment(order) {

        var options = {
            "key": "rzp_test_HFuZml3EB4GknT", // Enter the Key ID generated from the Dashboard
            "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            "currency": "INR",
            "name": "Porsche store",
            "description": "Test Transaction",
            "image": "https://example.com/your_logo",
            "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            "handler": function (response) {
                verifyPayment(response, order)
            },
            "prefill": {
                "name": "Ameer",
                "email": "Ameer@example.com",
                "contact": "9999999999"
            },
            "notes": {
                "address": "Razorpay Corporate Office"
            },
            "theme": {
                "color": "#3399cc"
            }
        };

        var rzp1 = new Razorpay(options);
        rzp1.open();
    }

    function verifyPayment(payment, order) {
        $.ajax({
            url: '/verify-payment',
            data: {
                payment,
                order
            },
            method: 'post',
            success: (response) => {
                if (response.status) {
                    location.href = '/order-success'
                } else {
                    swal("payment failed", '', 'error')
                }
            }
        })
    }

</script>